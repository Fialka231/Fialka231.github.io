<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Přihláška na školení ECOVIS</title>
  <style>
    :root { --ecovis-red:#b5121b; --ecovis-white:#ffffff; --muted:#666; --ink:#222; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--ecovis-white); color:var(--ink); margin:0; }
    header { background:var(--ecovis-red); color:white; padding:16px; display:flex; align-items:center; gap:14px; }
    header img { width:64px; height:64px; border-radius:50%; background:white; }
    header h1 { font-size:1.8rem; margin:0; }
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    form { background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.08); padding:24px; }

    fieldset { border:1px solid #e5e5e5; border-radius:10px; padding:16px; margin-bottom:20px; }
    legend { padding:0 6px; font-weight:600; color:var(--ecovis-red); }
    label { display:block; margin-top:8px; font-weight:500; }
    input, textarea, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:1rem; box-sizing:border-box; }
    textarea { min-height:100px; resize:vertical; }
    button { background:var(--ecovis-red); color:white; border:0; border-radius:8px; padding:12px 16px; font-size:1rem; cursor:pointer; }
    button:hover { opacity:0.9; }

    .checkline { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; margin-top:10px; cursor:pointer; }
    .checkline:hover { border-color: var(--ecovis-red); }
    .checkline input[type="checkbox"] { width:22px; height:22px; flex:0 0 22px; margin-top:3px; accent-color: var(--ecovis-red); }
    .checkline span { line-height:1.35; font-weight:500; }
    .checkline .hint { display:block; font-weight:400; color:var(--muted); margin-top:2px; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    #attendees { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; margin-top:12px; }
    .attendee-box { background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:12px; display:flex; flex-direction:column; }
    .attendee-box label { margin:0 0 4px 0; font-weight:500; font-size:0.95rem; }

    .muted-line { margin-top:6px; font-size:.9rem; color:var(--muted); display:block; }
    .inline { display:inline-block; min-width:160px; }

    .hint { font-size:.9rem; color:var(--muted); }
    .ok { color:green; }
    .err { color:#c62828; }

    #qrcode { display:none; margin-top:10px; }
    #qrcode img { max-width:150px; border:1px solid #ddd; padding:4px; }
  </style>
</head>
<body>
  <header>
    <img src="https://media.licdn.com/dms/image/v2/C4D0BAQEDUpY9Cfe5eg/company-logo_200_200/company-logo_200_200/0/1630518714792?e=2147483647&v=beta&t=-TTxTAKDyCQjMkaX8U-rIVESsqVSJxchJpp_IxWvoTY" alt="ECOVIS logo">
    <h1>Přihláška na školení ECOVIS</h1>
  </header>

  <div class="wrap">
    <form id="regForm">
      <!-- 1) Přednášky nahoře + termíny -->
      <fieldset>
        <legend>Výběr přednášek a termínů</legend>
        <legend id="priceLegend">CENÍK: 1 = 1650 Kč, 2 = 3100 Kč, 3 = 4500 Kč (na osobu)</legend>
        <div class="grid-2" id="lecturesContainer"></div>
      </fieldset>

      <!-- 2) Firma a kontakt -->
      <fieldset>
        <legend>Firma a kontakt</legend>
        <div class="grid-2">
          <div>
            <label>IČO společnosti*</label>
            <input type="text" id="ico" required placeholder="12345678" inputmode="numeric" pattern="\d{8}">
          </div>
          <div>
            <label>Kontaktní e-mail*</label>
            <input type="email" id="email" required placeholder="jana.novakova@firma.cz">
          </div>
        </div>

        <label>Název společnosti*</label>
        <input type="text" id="company" required placeholder="Firma s.r.o.">

        <input type="hidden" id="hidDic" />
        <input type="hidden" id="hidAddress" />

        <label>Telefon*</label>
        <input type="tel" id="phone" required placeholder="+420 777 888 999">

        <p id="aresMsg" class="hint"></p>
      </fieldset>

      <!-- 3) Účastníci -->
      <fieldset>
        <legend>Účastníci</legend
        <label>Počet účastníků*</label>
        <input type="number" id="qty" min="1" max="20" value="1" required>
        <div id="attendees"></div>
      </fieldset>

      <!-- 4) Další požadavky -->
      <fieldset>
        <legend>Další požadavky</legend>
        <label>Komentáře a požadavky</label>
        <textarea id="comments"></textarea>
        <label class="checkline">
          <input type="checkbox" id="gdpr" required>
          <span>Souhlasím se zpracováním osobních údajů
            <span class="hint"> pro účely registrace a fakturace</span>
          </span>
        </label>
      </fieldset>

      <p><strong>Celkem k úhradě:</strong> <span id="total">0 Kč</span></p>

      <div id="qrcode"></div>
      <p id="qrHint" class="hint" style="display:none;">QR kód byl úspěšně vygenerován pro platbu přes Raiffeisenbank.</p>

      <button type="submit">Odeslat přihlášku</button>
      <p id="msg" class="hint"></p>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    /* KONFIGURACE NA JEDNOM MÍSTĚ */
    const CONFIG = {
      pricing: {
        1: 1650,
        2: 3100,
        3: 4500
      },
      iban: "CZ7355000000005377695001",
      currency: "CZK",
      qrSize: "200x200",
      aresBase: "/api/ares?ico=",
      emailJsPublicKey: "FZNVPdu8YkKVsmazN",
      emailServiceId: "service_2udpiju",
      emailTemplateId: "template_zyyq9yf",
      ccEmail: "tereza.prochazkova@ecovis.cz", 
      lectures: [
        {
          id: "A",
          title: "Pracovní doba, dovolená a docházky – pro zaměstnavatele",
          description: "Pojmy, všeobecná pravidla, povinnosti, chyby zaměstnavatelů, rozvrh pracovní doby, změny dle novely ZP",
          selectId: "dateA",
          dates: [
            "10.12.2025, 9:00 - 12:00"
          ]
        },
        {
          id: "B",
          title: "Roční zúčtování daně 2025 z pohledu personalisty",
          description: "Povinnosti zaměstnanců a zaměstnavatele, návod na vyplnění formulářů, postup při RZD, daňové rezidenství, uplatnění dětí",
          selectId: "dateB",
          dates: [
            "17.12.2025, 9:00 - 12:00"
          ]
        },
        {
          id: "C",
          title: "Jednotné měsíční hlášení (JMHZ) z pohledu HR + náhled do změn v roce 2026",
          description: "Co je JMHZ, evidence zaměstnavatele a nové povinnosti, registrace zaměstnanců; přehled legislativních změn 2026, nové hodnoty a limity pro výpočty mezd",
          selectId: "dateC",
          dates: [
            "17.12.2025, 12:30 - 15:30"
          ]
        }
      ]
    };

    /* INIT EMAILJS */
    emailjs.init(CONFIG.emailJsPublicKey);

    /* DOM REFS */
    const qtyInput = document.getElementById('qty');
    const attendeesDiv = document.getElementById('attendees');
    const qrDiv = document.getElementById('qrcode');
    const qrHint = document.getElementById('qrHint');
    const aresMsg = document.getElementById('aresMsg');
    const lecturesContainer = document.getElementById('lecturesContainer');
    const priceLegend = document.getElementById('priceLegend');

    // ARES URL
    let ARES_BASE = CONFIG.aresBase;

    // interní proměnné pro ARES
    let aresDic = '';
    let aresAddress = '';

    /* DYNAMICKÉ VYKRESLENÍ PŘEDNÁŠEK */
    function renderLectures() {
      lecturesContainer.innerHTML = '';
      CONFIG.lectures.forEach(lec => {
        const label = document.createElement('label');
        label.className = 'checkline';
        label.innerHTML = `
          <input type="checkbox" name="lectures" value="${lec.title}">
          <span>
            <strong>${lec.title}</strong>
            <span class="hint">${lec.description}</span>
            <span class="muted-line">Termín:
              <select id="${lec.selectId}" class="inline">
                <option value="">Vyberte termín</option>
                ${lec.dates.map(d => `<option>${d}</option>`).join('')}
              </select>
            </span>
          </span>
        `;
        lecturesContainer.appendChild(label);
      });

      // Eventy pro checkboxy po vykreslení
      document.querySelectorAll('input[name="lectures"]').forEach(cb =>
        cb.addEventListener('change', calcTotal)
      );
    }

    // Nastavení textu ceníku z CONFIG
    if (priceLegend) {
      priceLegend.textContent =
        `CENÍK: 1 = ${CONFIG.pricing[1]} Kč, 2 = ${CONFIG.pricing[2]} Kč, 3 = ${CONFIG.pricing[3]} Kč (na osobu)`;
    }

    /* Účastníci */
    function updateAttendeeBoxes(){
      const count = parseInt(qtyInput.value || '0', 10);
      attendeesDiv.innerHTML = '';
      for (let i = 1; i <= count; i++) {
        const box = document.createElement('div');
        box.className = 'attendee-box';
        box.innerHTML = `<label>Účastník ${i} – jméno</label><input type="text" name="attendee${i}" placeholder="Jméno účastníka ${i}" required>`;
        attendeesDiv.appendChild(box);
      }
    }

    /* Cena */
    function getPricePerPerson(lecturesCount) {
      return CONFIG.pricing[lecturesCount] || 0;
    }

    function calcTotal(){
      const qty = parseInt(document.getElementById('qty').value || '0', 10);
      const lectures = Array.from(document.querySelectorAll('input[name="lectures"]:checked')).map(x => x.value);

      const pricePerPerson = getPricePerPerson(lectures.length);
      const total = pricePerPerson * qty;

      document.getElementById('total').textContent = total.toLocaleString('cs-CZ') + ' Kč';
      return { total, lectures, qty };
    }

    /* QR Platba SPD 1.0 */
    function buildQrPayload(amount, vs, msg){
      return `SPD*1.0*ACC:${CONFIG.iban}*AM:${amount.toFixed(2)}*CC:${CONFIG.currency}*X-VS:${vs}*MSG:${encodeURIComponent(msg)}`;
    }

    function generateQr(amount, vs, msg){
      const payload = buildQrPayload(amount, vs, msg);
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=${CONFIG.qrSize}&data=${payload}`;
      qrDiv.innerHTML = `<img src="${url}" alt="QR Platba">`;
      return url;
    }

    /* ARES autofill přes proxy */
    function pickObchodniJmeno(es) {
      const name = es?.obchodniJmeno;
      if (!name) return '';
      if (typeof name === 'string') return name;
      if (Array.isArray(name)) {
        const prim = name.find(n => n?.primarniZaznam && n?.obchodniJmeno);
        return (prim?.obchodniJmeno || name[0]?.obchodniJmeno || '').toString();
      }
      return '';
    }

    function formatAdresa(a) {
      if (!a) return '';
      if (a.textovaAdresa) return a.textovaAdresa;
      const cislo = [a.cisloDomovni, a.cisloOrientacni && `${a.cisloOrientacni}${a.cisloOrientacniPismeno || ''}`]
        .filter(Boolean).join('/');
      const psc = a.psc ? String(a.psc).padStart(5, '0') : '';
      return [a.nazevUlice, cislo, a.nazevCastiObce, [psc, a.nazevObce].filter(Boolean).join(' ')]
        .filter(Boolean).join(', ');
    }

    function parseAresResponse(json) {
      const es = json || {};
      const firma = pickObchodniJmeno(es);
      const adresa = es.sidlo ? formatAdresa(es.sidlo) : '';
      const dic = es.dic || '';
      return { firma, adresa, dic };
    }

    async function fetchAresByICO(icoRaw) {
      const ico = (icoRaw || '').replace(/\D/g, '');
      if (!/^\d{8}$/.test(ico)) throw new Error('Neplatné IČO, očekáváno 8 číslic.');
      const url = `${ARES_BASE}${encodeURIComponent(ico)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if (!res.ok || data?.error) throw new Error(data?.error || `Chyba ARES proxy ${res.status}`);
      return parseAresResponse(data);
    }

    const icoInput = document.getElementById('ico');
    icoInput.addEventListener('change', tryAres);
    icoInput.addEventListener('blur', tryAres);

    async function tryAres() {
      const v = icoInput.value.trim();
      if (!v) return;
      aresMsg.textContent = 'Načítám data z ARES…';
      try {
        const { firma, adresa, dic } = await fetchAresByICO(v);
        if (firma) document.getElementById('company').value = firma;
        aresDic = dic || '';
        aresAddress = adresa || '';
        document.getElementById('hidDic').value = aresDic;
        document.getElementById('hidAddress').value = aresAddress;
        aresMsg.textContent = 'Údaje doplněny z ARES.';
      } catch (err) {
        console.warn(err);
        aresMsg.textContent = '';
      }
    }

    /* Init */
    renderLectures();
    updateAttendeeBoxes();
    calcTotal();

    qtyInput.addEventListener('input', () => {
  if (qtyInput.value > 20) qtyInput.value = 20;
  if (qtyInput.value < 1) qtyInput.value = 1;
  updateAttendeeBoxes();
  calcTotal();
});

    /* Odeslání */
    document.getElementById('regForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const { total, lectures, qty } = calcTotal();
      const company = document.getElementById('company').value;
      const ico = document.getElementById('ico').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const comments = document.getElementById('comments').value || '-';

      const lectureDates = [];
      CONFIG.lectures.forEach(lec => {
        if (lectures.includes(lec.title)) {
          const dateVal = document.getElementById(lec.selectId).value || '-';
          lectureDates.push(`${lec.title}: ${dateVal}`);
        }
      });

      const msgText = `Školení ECOVIS – ${lectures.join(', ')} – ${company}`;
      const qrUrl = generateQr(total, ico, msgText);

      const attendeeInputs = attendeesDiv.querySelectorAll('input[name^="attendee"]');
      const attendeeNames = Array.from(attendeeInputs)
        .map((a,i)=>`Účastník ${i+1}: ${a.value || '-'}`)
        .join('\n');

      const data = {
        company,
        ico,
        ares_dic: aresDic,
        ares_address: aresAddress,
        email,
        phone,
        event_date: lectureDates.join(', '),
        lectures: lectures.join(', '),
        attendees: String(qty),
        attendee_names: attendeeNames,
        comments,
        amount: total + ' Kč',
        vs: ico,
        qr_image_base64: qrUrl
      };

      try {
        await emailjs.send(CONFIG.emailServiceId, CONFIG.emailTemplateId, {
          ...data,
          reply_to: email,
          cc_email: CONFIG.ccEmail
        });
        document.getElementById('msg').textContent = 'Přihláška odeslána. Potvrzení bylo zasláno na ' + email;
        document.getElementById('msg').className = 'ok';
        qrDiv.style.display = 'block';
        qrHint.style.display = 'block';
      } catch (err) {
        console.error(err);
        document.getElementById('msg').textContent = 'Chyba při odesílání e-mailu.';
        document.getElementById('msg').className = 'err';
      }
    });
  </script>
</body>
</html>
